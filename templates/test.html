<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Test Bot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f7f7f8;color:#111}
    .wrap{max-width:780px;margin:24px auto;padding:16px}
    .row{display:flex;gap:8px;margin-bottom:8px}
    input,button,textarea{font:inherit}
    input,textarea{padding:10px;border:1px solid #ddd;border-radius:8px;flex:1;background:#fff}
    button{padding:10px 14px;border:0;border-radius:8px;background:#111;color:#fff;cursor:pointer}
    .chat{background:#fff;border:1px solid #eee;border-radius:12px; padding:10px 12px; height:420px; overflow:auto}
    .msg{margin:8px 0;display:flex}
    .me{justify-content:flex-end}
    .me .bubble{background:#e8f0ff;color:#0a1b4d}
    .bot .bubble{background:#f0f0f0}
    .bubble{max-width:70%;padding:10px 12px;border-radius:12px}
    .small{font-size:12px;color:#666;margin-top:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Tester Bot</h2>
    <div class="row">
      <input id="phone" placeholder="Telefono (es: 3934...)" />
      <button id="set">Usa numero</button>
      <button id="reset">Reset conversazione</button>
    </div>
    <div class="chat" id="chat"></div>
    <div class="row">
      <input id="msg" placeholder="Scrivi un messaggio..." />
      <button id="send">Invia</button>
    </div>
    <div class="small">NB: questa pagina invia al backend su <code>/test_api</code> simulando Twilio.</div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const msg = document.getElementById('msg');
    const phone = document.getElementById('phone');
    let currentPhone = localStorage.getItem('tester_phone') || '';

    function add(role, text){
      const line = document.createElement('div');
      line.className = 'msg ' + (role === 'me' ? 'me' : 'bot');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      line.appendChild(b);
      chat.appendChild(line);
      chat.scrollTop = chat.scrollHeight;
    }

    function loadHistory(){
      const h = JSON.parse(localStorage.getItem('history_'+currentPhone) || '[]');
      chat.innerHTML = '';
      h.forEach(x => add(x.role,x.text));
    }
    function pushHistory(role, text){
      const k = 'history_'+currentPhone;
      const h = JSON.parse(localStorage.getItem(k) || '[]');
      h.push({role,text});
      localStorage.setItem(k, JSON.stringify(h));
    }

    document.getElementById('set').onclick = ()=>{
      if(!phone.value.trim()) return alert('Inserisci un numero');
      currentPhone = phone.value.trim();
      localStorage.setItem('tester_phone', currentPhone);
      loadHistory();
    };

    document.getElementById('reset').onclick = ()=>{
      if(!currentPhone) return alert('Imposta prima un numero');
      localStorage.removeItem('history_'+currentPhone);
      chat.innerHTML = '';
      add('bot','âœ… Conversazione resettata. Scrivi un messaggio.');
    };

    document.getElementById('send').onclick = async ()=>{
      if(!currentPhone) return alert('Imposta prima un numero');
      if(!msg.value.trim()) return;
      const text = msg.value;
      msg.value = '';
      add('me', text);
      pushHistory('me', text);

      const fd = new FormData();
      fd.append('Phone', currentPhone);
      fd.append('Body', text);
      const r = await fetch('/test_api', {method:'POST', body:fd});
      const t = await r.text();
      const m = t.match(/<Message>([\s\S]*?)<\/Message>/i);
      const reply = m ? m[1] : '(nessuna risposta)';
      add('bot', reply);
      pushHistory('bot', reply);
    };

    // init
    if(currentPhone){ phone.value = currentPhone; loadHistory(); }
  </script>
</body>
</html>
