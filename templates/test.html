<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test Bot</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    #chat { border: 1px solid #ddd; border-radius: 8px; padding: 12px; height: 60vh; overflow-y: auto; background: #fafafa; }
    .row { margin: 6px 0; }
    .me { text-align: right; }
    .me span { background: #d1f1ff; padding: 8px 10px; border-radius: 12px; display: inline-block; }
    .bot span { background: #fff; padding: 8px 10px; border-radius: 12px; display: inline-block; }
    #bar { display: flex; gap: 8px; margin-top: 10px; }
    input,button { font-size: 16px; padding: 8px; }
    #phone { width: 220px; }
    #msg { flex: 1; }
  </style>
</head>
<body>
  <h2>Console di test</h2>
  <div style="margin-bottom:8px;">
    Telefono: <input id="phone" placeholder="Es. 3931234567" />
    <button id="set">Imposta</button>
  </div>

  <div id="chat"></div>

  <div id="bar">
    <input id="msg" placeholder="Scrivi un messaggio…" />
    <button id="send">Invia</button>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('msg');
    const phoneInput = document.getElementById('phone');
    const btnSend = document.getElementById('send');
    const btnSet = document.getElementById('set');

    // ripristina/ricorda il numero
    phoneInput.value = localStorage.getItem('test_phone') || '';

    function addRow(who, text) {
      const div = document.createElement('div');
      div.className = 'row ' + who;
      const span = document.createElement('span');
      span.textContent = text;
      div.appendChild(span);
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    btnSet.onclick = () => {
      const p = phoneInput.value.trim();
      if (!p) { alert('Inserisci il telefono'); return; }
      localStorage.setItem('test_phone', p);
      addRow('bot', `Telefono impostato: ${p}. Scrivi un messaggio…`);
    };

    async function send() {
      const phone = (phoneInput.value || '').trim();
      const message = (input.value || '').trim();
      if (!phone) { alert('Imposta il telefono'); return; }
      if (!message) return;

      addRow('me', message);
      input.value = '';

      try {
        const res = await fetch('/test_api', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ phone, message })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          addRow('bot', `Errore: ${data.error || res.statusText}`);
          return;
        }
        addRow('bot', data.reply);
      } catch (e) {
        addRow('bot', 'Errore di rete: ' + e.message);
      }
    }

    btnSend.onclick = send;
    input.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });

    // messaggio di benvenuto
    if (!chat.dataset.init) {
      chat.dataset.init = '1';
      addRow('bot', 'sys: Conversazione pronta. Inserisci telefono e invia il primo messaggio.');
    }
  </script>
</body>
</html>
