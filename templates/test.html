<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Hotel Bot - Test Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#f6f7f8; }
    header { background:#111827; color:#fff; padding:12px 16px; }
    main { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display:flex; gap:12px; padding:16px; align-items:center; }
    input[type="text"] { padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; width:100%; }
    button { padding:10px 14px; border:none; background:#111827; color:#fff; border-radius:8px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .chat { padding: 8px 16px 16px; height: 60vh; overflow-y: auto; }
    .bubble { max-width: 70%; padding:10px 12px; border-radius:10px; margin:8px 0; line-height:1.35 }
    .me { background:#dbeafe; margin-left:auto; }
    .bot { background:#f3f4f6; margin-right:auto; }
    .meta { color:#6b7280; font-size:12px; margin-top:2px; }
    .row-top { border-bottom:1px solid #e5e7eb; }
  </style>
</head>
<body>
  <header><strong>Hotel Bot • Test</strong></header>
  <main>
    <div class="card">
      <div class="row row-top">
        <div style="flex: 0 0 180px;">
          <label>Telefono</label>
          <input id="phone" type="text" placeholder="es. 393470412345" />
        </div>
        <div style="flex:1;">
          <div style="color:#6b7280;font-size:14px">Conversazione di test. I messaggi restano nello storico.</div>
        </div>
        <div>
          <button id="reset">Reset</button>
        </div>
      </div>
      <div id="chat" class="chat"></div>
      <div class="row">
        <input id="msg" type="text" placeholder="Scrivi un messaggio…" />
        <button id="send">Invia</button>
      </div>
    </div>
  </main>
  <script>
    const chat = document.getElementById('chat');
    const phoneInput = document.getElementById('phone');
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const resetBtn = document.getElementById('reset');

    function append(role, text){
      const wrap = document.createElement('div');
      wrap.className = 'bubble ' + (role === 'me' ? 'me' : 'bot');
      wrap.textContent = text;
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }

    sendBtn.onclick = async () => {
      const phone = phoneInput.value.trim();
      const text = msgInput.value.trim();
      if(!phone){ alert('Inserisci telefono (solo numeri)'); return; }
      if(!text){ return; }
      append('me', text);
      msgInput.value = '';
      sendBtn.disabled = true;
      try{
        const fd = new FormData();
        fd.append('phone', phone);
        fd.append('text', text);
        const r = await fetch('/test_api', { method:'POST', body: fd });
        const js = await r.json();
        if(js.ok){
          append('bot', js.reply);
        } else {
          append('bot', 'Errore: ' + (js.error || 'unknown'));
        }
      }catch(e){
        append('bot', 'Errore di rete');
      }finally{
        sendBtn.disabled = false;
      }
    };

    resetBtn.onclick = () => {
      msgInput.value = '/reset';
      sendBtn.onclick();
    };
  </script>
</body>
</html>
