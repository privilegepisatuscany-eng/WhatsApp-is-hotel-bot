<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test Bot</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; }
    #log { border: 1px solid #ddd; padding: 10px; height: 60vh; overflow-y: auto; white-space: pre-wrap; }
    .msg-me { color: #0b6; }
    .msg-bot { color: #06c; }
    .sys { color: #999; font-style: italic; }
    input, button { font-size: 16px; padding: 8px; }
    input[type="text"] { flex: 1; }
  </style>
</head>
<body>
  <div id="log"></div>

  <div class="row">
    <input id="phone" type="text" placeholder="Telefono (es. 3934...)" />
    <button id="setPhone">Imposta</button>
  </div>

  <div class="row">
    <input id="text" type="text" placeholder="Scrivi un messaggio..." />
    <button id="send">Invia</button>
    <button id="reset">Reset</button>
  </div>

  <script>
    const log = document.getElementById('log');
    const phoneInput = document.getElementById('phone');
    const textInput = document.getElementById('text');

    function addLine(html, cls="") {
      const p = document.createElement('div');
      p.className = cls;
      p.innerHTML = html;
      log.appendChild(p);
      log.scrollTop = log.scrollHeight;
    }

    function getPhone() {
      return localStorage.getItem('test_phone') || "";
    }

    function setPhone(p) {
      localStorage.setItem('test_phone', p);
      addLine(`sys: Telefono impostato a ${p}`, 'sys');
    }

    // Init
    (function() {
      const p = getPhone();
      if (p) phoneInput.value = p;
      addLine('sys: Conversazione pronta. Inserisci telefono e invia il primo messaggio.', 'sys');
    })();

    document.getElementById('setPhone').onclick = () => {
      const p = phoneInput.value.trim().replace(/^\+/, '');
      if (!p) return;
      setPhone(p);
    };

    document.getElementById('send').onclick = async () => {
      const phone = getPhone();
      const body = textInput.value.trim();
      if (!phone || !body) {
        addLine('sys: serve telefono e messaggio.', 'sys');
        return;
      }
      addLine(`me: ${body}`, 'msg-me');

      try {
        const resp = await fetch('/test_api', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ phone, body })
        });
        if (!resp.ok) {
          const txt = await resp.text();
          addLine(`sys: errore ${resp.status} - ${txt}`, 'sys');
          return;
        }
        const data = await resp.json();
        addLine(`bot: ${data.reply}`, 'msg-bot');
      } catch (e) {
        addLine(`sys: errore di rete: ${e}`, 'sys');
      } finally {
        textInput.value = '';
      }
    };

    document.getElementById('reset').onclick = async () => {
      const phone = getPhone();
      if (!phone) { addLine('sys: imposta prima il telefono.', 'sys'); return; }
      try {
        const r = await fetch(`/reset_session?phone=${encodeURIComponent(phone)}`, { method: 'POST' });
        if (r.ok) addLine('sys: sessione resettata.', 'sys');
        else addLine(`sys: reset fallito (${r.status})`, 'sys');
      } catch (e) {
        addLine(`sys: errore di rete: ${e}`, 'sys');
      }
    };
  </script>
</body>
</html>
